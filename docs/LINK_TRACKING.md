# Link Tracking Feature

## Overview
The link tracking feature automatically shortens and tracks all links in email drafts using the YOURLS URL shortener service. This allows tracking of link clicks without relying on image-based tracking (which Outlook blocks).

## How It Works

### Link Processing Flow
1. **Draft Creation**: When creating an email draft via `/api/draft/create`
2. **HTML Parsing**: `LinkTrackingService` parses the email HTML using DOMDocument
3. **Link Detection**: Finds all `<a href>` tags and categorizes them
4. **URL Shortening**: 
   - **Veerless.com URLs**: Preserves path, adds 6-character tracking code
   - **External URLs**: Generates random YOURLS keyword
5. **Link Replacement**: Replaces original URLs with short URLs in HTML
6. **Database Storage**: Saves link tracking records (optional, requires email_id)

### URL Handling Rules

#### Veerless URLs
- **Original**: `https://veerless.com/our-services`
- **Keyword**: `our-services-abc123` (path + tracking code)
- **Short URL**: `https://veerl.es/our-services-abc123`
- **Tracking Code**: 6-character lowercase alphanumeric

#### External URLs
- **Original**: `https://espn.com/nfl/scores`
- **Keyword**: `xyz123` (random, generated by YOURLS)
- **Short URL**: `https://veerl.es/xyz123`

#### Skipped URLs
- `mailto:` links
- `tel:` links
- `#` anchor links
- `javascript:` links

## Setup

### 1. Environment Configuration
Add to `.env`:
```env
YOURLS_API_URL=https://veerl.es/yourls-api.php
YOURLS_API_SIGNATURE=e150dd0e84
```

### 2. Database Migration
Run migration to create `link_tracking` table:
```bash
php migrations/migrate.php
```

### 3. YOURLS Configuration
- API endpoint: `https://veerl.es/yourls-api.php`
- Authentication: Signature-based (`signature=e150dd0e84`)
- Actions: `shorturl` (create), `url-stats` (get click counts)

## Database Schema

### `link_tracking` Table
```sql
CREATE TABLE link_tracking (
    id INT AUTO_INCREMENT PRIMARY KEY,
    email_id INT DEFAULT NULL,
    original_url VARCHAR(2048) NOT NULL,
    short_url VARCHAR(255) NOT NULL,
    yourls_keyword VARCHAR(255) NOT NULL,
    url_type ENUM('veerless', 'external') NOT NULL,
    tracking_code VARCHAR(50) DEFAULT NULL,
    clicks INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (email_id) REFERENCES emails(id) ON DELETE CASCADE,
    INDEX idx_yourls_keyword (yourls_keyword),
    INDEX idx_email_id (email_id)
);
```

## Architecture

### Components

#### 1. **YourlsClient** (`src/Services/YourlsClient.php`)
- API wrapper for YOURLS service
- Methods:
  - `createShortUrl($url, $keyword = null)`: Create short URL
  - `getStats($keyword)`: Get click statistics

#### 2. **LinkTrackingRepository** (`src/Repositories/LinkTrackingRepository.php`)
- Database operations for link tracking
- Methods:
  - `create($data)`: Insert link record
  - `getByEmailId($emailId)`: Get all links for an email
  - `updateClicks($keyword, $clicks)`: Update click count
  - `getLinkStats()`: Get aggregate statistics

#### 3. **LinkTrackingService** (`src/Services/LinkTrackingService.php`)
- Core link processing logic
- Methods:
  - `processLinks($htmlBody, $emailId)`: Main processing method
  - `getProcessedLinks()`: Get links from last processing
  - Private helpers for URL parsing and YOURLS API calls

#### 4. **OutlookDraftService** (Modified)
- Integrated link tracking into draft creation
- Optional dependency (disabled if YOURLS not configured)
- Processes links after HTML sanitization, before sending to Graph API

### Dependency Injection
```php
// index.php
$linkTrackingService = null;
if (!empty($_ENV['YOURLS_API_URL']) && !empty($_ENV['YOURLS_API_SIGNATURE'])) {
    $yourlsClient = new YourlsClient($logger);
    $linkTrackingService = new LinkTrackingService($yourlsClient, $linkTrackingRepo, $logger);
}

$outlookDraftService = new OutlookDraftService($logger, $linkTrackingService);
```

## API Usage

### Create Draft with Link Tracking
**Request:**
```http
POST /api/draft/create
Content-Type: application/json

{
  "to": "recipient@example.com",
  "subject": "Meeting Request",
  "body": "<p>Visit our <a href=\"https://veerless.com/contact\">contact page</a></p>",
  "user": "charlie@veerless.com"
}
```

**Processing:**
1. Link `https://veerless.com/contact` is detected
2. Keyword generated: `contact-abc123`
3. YOURLS creates: `https://veerl.es/contact-abc123`
4. HTML updated: `<a href="https://veerl.es/contact-abc123">`
5. Draft created in Outlook with short URL

**Response:**
```json
{
  "status": "success",
  "message": "Draft created successfully",
  "draft_id": "AAMkAG...",
  "web_link": "https://outlook.office365.com/owa/?ItemID=AAMkAG..."
}
```

## Testing

### 1. Simple YOURLS API Test
```bash
php tests/test-yourls-simple.php
```
Tests direct YOURLS API calls:
- Veerless URL with custom keyword
- External URL with random keyword
- HTML link parsing

### 2. Full Integration Test
```bash
php tests/test-link-tracking.php
```
Tests complete LinkTrackingService:
- Multiple link types
- HTML parsing with DOMDocument
- Database storage
- Link replacement

### 3. Manual Test via API
```bash
curl -X POST http://localhost/networkemailtracking/api/draft/create \
  -H "Content-Type: application/json" \
  -d '{
    "to": "test@example.com",
    "subject": "Test",
    "body": "<p>Check out <a href=\"https://veerless.com/about\">our site</a></p>",
    "user": "charlie@veerless.com"
  }'
```

## Monitoring & Analytics

### View Link Statistics
Query the database:
```sql
-- Get all tracked links for an email
SELECT * FROM link_tracking WHERE email_id = 123;

-- Get click summary
SELECT 
    url_type,
    COUNT(*) as total_links,
    SUM(clicks) as total_clicks,
    AVG(clicks) as avg_clicks_per_link
FROM link_tracking
GROUP BY url_type;

-- Get top clicked links
SELECT original_url, short_url, clicks
FROM link_tracking
ORDER BY clicks DESC
LIMIT 10;
```

### Sync Click Counts from YOURLS
```php
// Future enhancement: scheduled task to sync clicks
$linkTrackingService->syncClickCounts();
```

## Future Enhancements

### Dashboard Integration
- [ ] Display link statistics on dashboard
- [ ] Show click-through rates per email
- [ ] Top performing links report

### Webhook for Click Events
- [ ] YOURLS callback on link click
- [ ] Real-time click notifications
- [ ] Store click metadata (IP, user-agent, timestamp)

### Link Analytics
- [ ] Click heatmap by time of day
- [ ] Geographic click distribution
- [ ] Device/browser breakdown

### Batch Click Sync
- [ ] Scheduled job to update click counts
- [ ] Sync from YOURLS API periodically
- [ ] Update `clicks` column in `link_tracking` table

## Troubleshooting

### Links Not Being Shortened
1. Check `.env` has `YOURLS_API_URL` and `YOURLS_API_SIGNATURE`
2. Verify YOURLS API is accessible: `curl https://veerl.es/yourls-api.php?signature=e150dd0e84&action=version`
3. Check logs: `tail -f logs/app-*.log`

### Links Not Tracked in Database
- Link tracking requires `email_id` parameter
- Currently set to `null` in OutlookDraftService (email not saved yet)
- Future: Link email draft to database record before processing

### YOURLS Errors
- **Error 403**: Invalid API signature
- **Error 500**: YOURLS database issue
- **"error: Please log in"**: Signature not provided or incorrect

## Security Considerations

### API Signature
- Store in `.env`, never commit to Git
- Rotate periodically
- Use environment-specific signatures for dev/prod

### URL Validation
- Service validates URL format before shortening
- Prevents malicious URL injection
- Skips javascript: and other dangerous protocols

### Database
- Foreign key constraint to `emails` table
- Cascading deletes when email is removed
- Index on `yourls_keyword` for fast lookups

## Performance

### Optimization Strategies
1. **Batch API Calls**: Process all links in one pass
2. **Caching**: Cache frequently used short URLs
3. **Async Processing**: Queue link shortening for large emails
4. **Rate Limiting**: Respect YOURLS API limits

### Benchmarks
- Average processing time: ~500ms for 5-10 links
- YOURLS API latency: ~200ms per request
- Database insert: <10ms per link

## Deployment

### Production Checklist
- [x] Migration run on production database
- [x] `.env` updated with YOURLS credentials
- [x] Code committed to feature branch
- [ ] Merge to main branch
- [ ] Deploy to production server
- [ ] Test with real email draft
- [ ] Verify YOURLS dashboard shows new links
- [ ] Monitor logs for errors

### Rollback Plan
If issues occur:
1. Remove YOURLS config from `.env`
2. Link tracking will be disabled (graceful fallback)
3. Original URLs will be used in drafts
4. No data loss (links stored in database)

## Related Files
- Migration: [migrations/007_create_link_tracking_table.php](migrations/007_create_link_tracking_table.php)
- Service: [src/Services/LinkTrackingService.php](src/Services/LinkTrackingService.php)
- Repository: [src/Repositories/LinkTrackingRepository.php](src/Repositories/LinkTrackingRepository.php)
- Client: [src/Services/YourlsClient.php](src/Services/YourlsClient.php)
- Integration: [src/Services/OutlookDraftService.php](src/Services/OutlookDraftService.php#L67-L73)
- Config: [index.php](index.php#L87-L91)

